<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phác thảo mặt bằng trạm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    body {
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      margin-bottom: 15px;
      font-weight: bold;
    }
    #inputContainer {
      max-width: 800px;
      margin: 0 auto 20px auto;
      box-sizing: border-box;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 30px;
      background-color: white;
      padding: 15px 25px 25px 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      font-size: 18px;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 12px 14px;
      font-size: 18px;
      border: 1px solid #aaa;
      border-radius: 6px;
      box-sizing: border-box;
      resize: vertical;
      background-color: white;
      color: black;
      font-family: Arial, sans-serif;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #004400;
      outline: none;
    }
    textarea {
      min-height: 48px;
    }
    button {
      background-color: #f0c000;
      color: #004400;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease, color 0.3s ease;
      margin-top: 15px;
      width: 220px;
      justify-self: center;
      border-radius: 8px;
      font-size: 18px;
      padding: 12px 0;
      box-shadow: 0 0 8px rgba(240,192,0,0.7);
    }
    button:hover {
      background-color: #cc0000;
      color: white;
      box-shadow: 0 0 10px rgba(204,0,0,0.8);
    }
    #infoUpdate {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
      color: #003300;
      background-color: #d3d3d3;
      padding: 14px 20px;
      border-radius: 8px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      font-size: 18px;
      font-family: Arial, sans-serif;
    }
#map {
  flex-grow: 1;
  min-height: 300px;
  border-radius: 8px;
  border: 1px solid #ccc;
  max-width: 900px;
  margin: 20px auto 0 auto;
  box-sizing: border-box;
  box-shadow: 0 0 15px rgba(0,0,0,0.15);
  background-color: white;
}

    @media (max-width: 700px) {
      .form-grid {
        grid-template-columns: 1fr;
        padding: 10px 15px 15px 15px;
        gap: 15px;
      }
      button {
        width: 100%;
      }
      #inputContainer {
        padding: 0 8px;
        margin-bottom: 15px;
      }
      #map {
        height: 90vh;
        border-radius: 4px;
      }
      #infoUpdate {
        font-size: 16px;
        padding: 10px;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>Phác thảo mặt bằng trạm</h1>

  <div id="inputContainer">
    <div class="form-grid">
      <div>
        <label for="siteCode">Mã trạm:</label>
        <textarea id="siteCode" placeholder="Nhập mã trạm" rows="2" onfocus="clearInput(this)">MAP123</textarea>
      </div>

      <div>
        <label for="moCoord">Tọa độ MO (lat, lng):</label>
        <textarea id="moCoord" placeholder="lat, lng" rows="2" onfocus="clearInput(this)">-25.9493454, 32.5620781</textarea>
      </div>

      <div>
        <label for="azimuth">Hướng cửa trạm (Azimuth - độ):</label>
        <input id="azimuth" value="30" type="number" min="0" max="360" step="0.1" onfocus="clearInput(this)" />
      </div>

      <div>
        <label for="fenceSize">Kích thước hàng rào (m):</label>
        <select id="fenceSize">
          <option value="6x8">6x8</option>
          <option value="6x10">6x10</option>
          <option value="4x4">4x4</option>
          <option value="10x10">10x10</option>
          <option value="8x12">8x12</option>
        </select>
      </div>

      <div>
        <label for="foundationType">Loại móng cột:</label>
        <select id="foundationType">
          <option value="guyed">Dây co</option>
          <option value="self35">Tự đứng 35m</option>
          <option value="self30">Tự đứng 30m</option>
        </select>
      </div>

      <div>
        <label for="guyCount">Số móng co:</label>
        <select id="guyCount">
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>

      <div>
        <label for="towerHeight">Độ cao cột (m):</label>
        <select id="towerHeight">
          <option value="38.5">38.5</option>
          <option value="44">44</option>
          <option value="49.5">49.5</option>
          <option value="55">55</option>
          <option value="60.5">60.5</option>
          <option value="66">66</option>
          <option value="71.5">71.5</option>
          <option value="77">77</option>
        </select>
      </div>
    </div>

    <button id="drawBtn">Vẽ mặt bằng</button>
    <div id="infoUpdate">Nhập thông tin và nhấn "Vẽ mặt bằng" để cập nhật bản đồ.</div>
  </div>

  <div id="map"></div>

  <script>
    // Giữ nguyên tất cả logic gốc (copy nguyên từ bạn gửi)

    let map;
    let overlays = [];

    const guyRadiusTable = {
      "38.5": 13, "44": 15, "49.5": 16, "55": 18,
      "60.5": 20, "66": 22, "71.5": 24, "77": 26
    };

    function parseCoord(input) {
      const parts = input.split(',').map(p => parseFloat(p.trim()));
      if (parts.length !== 2 || parts.some(isNaN)) {
        alert("Tọa độ MO không hợp lệ, vui lòng nhập theo định dạng: lat, lng");
        throw new Error("Invalid coordinate");
      }
      return { lat: parts[0], lng: parts[1] };
    }

    function moveLatLng(origin, dx, dy) {
      const R = 6378137;
      const dLat = dy / R * 180 / Math.PI;
      const dLng = dx / (R * Math.cos(origin.lat * Math.PI / 180)) * 180 / Math.PI;
      return { lat: origin.lat + dLat, lng: origin.lng + dLng };
    }

    function rotateXY(x, y, angleDeg) {
      const rad = angleDeg * Math.PI / 180;
      return {
        x: x * Math.cos(rad) - y * Math.sin(rad),
        y: x * Math.sin(rad) + y * Math.cos(rad)
      };
    }

    function drawConcreteFootingFromTarget(target, angleDeg) {
      const halfSide = 1.5;
      const length = 3;
      const perpAngle = angleDeg + 90;

      const p1 = moveLatLng(target,  halfSide * Math.sin(perpAngle * Math.PI / 180),
                                     halfSide * Math.cos(perpAngle * Math.PI / 180));
      const p2 = moveLatLng(target, -halfSide * Math.sin(perpAngle * Math.PI / 180),
                                    -halfSide * Math.cos(perpAngle * Math.PI / 180));

      const p3 = moveLatLng(p2,  length * Math.sin(angleDeg * Math.PI / 180),
                                   length * Math.cos(angleDeg * Math.PI / 180));
      const p4 = moveLatLng(p1,  length * Math.sin(angleDeg * Math.PI / 180),
                                   length * Math.cos(angleDeg * Math.PI / 180));

      const polygon = new google.maps.Polygon({
        paths: [p1, p2, p3, p4],
        map: map,
        strokeColor: '#FF0000',
        fillColor: '#FF0000',
        fillOpacity: 0.8,
        strokeWeight: 1
      });
      overlays.push(polygon);
    }

    function drawArc(center, radius, startAngle, endAngle, color = '#00FF00') {
      const path = [];
      for (let angle = startAngle; angle <= endAngle; angle += 2) {
        const rad = angle * Math.PI / 180;
        const x = radius * Math.sin(rad);
        const y = radius * Math.cos(rad);
        path.push(moveLatLng(center, x, y));
      }
      const arc = new google.maps.Polyline({
        path,
        map: map,
        strokeColor: color,
        strokeOpacity: 1,
        strokeWeight: 2
      });
      overlays.push(arc);

      const end = moveLatLng(center, radius * Math.sin(endAngle * Math.PI / 180), radius * Math.cos(endAngle * Math.PI / 180));
      const refLine = new google.maps.Polyline({
        path: [center, end],
        map: map,
        strokeColor: color,
        strokeOpacity: 1,
        strokeWeight: 1,
        zIndex: 50
      });
      overlays.push(refLine);
    }

    function drawEquilateralTriangle(center, sideLength, azimuth) {
      const height = Math.sqrt(3) / 2 * sideLength; // chiều cao tam giác đều
      const d = (2/3) * height; // khoảng cách từ trọng tâm đến đỉnh

      const p1 = { x: 0, y: -d };
      const p2 = { x: -sideLength/2, y: height - d };
      const p3 = { x: sideLength/2, y: height - d };

      const pointsRotated = [p1, p2, p3]
        .map(p => rotateXY(p.x, p.y, -azimuth))
        .map(p => moveLatLng(center, p.x, p.y));

      return pointsRotated;
    }

    function drawLayout() {
      let coord;
      try {
        coord = parseCoord(document.getElementById("moCoord").value);
      } catch {
        return;
      }
      const azimuth = parseFloat(document.getElementById("azimuth").value);
      if (isNaN(azimuth) || azimuth < 0 || azimuth > 360) {
        alert("Vui lòng nhập Azimuth hợp lệ từ 0 đến 360.");
        return;
      }
      const size = document.getElementById("fenceSize").value.split("x");
      const width = parseFloat(size[0]);
      const height = parseFloat(size[1]);
      const foundationType = document.getElementById("foundationType").value;
      const guyCount = parseInt(document.getElementById("guyCount").value);
      const towerHeight = document.getElementById("towerHeight").value;
      const radius = guyRadiusTable[towerHeight];

      if (!map) {
        map = new google.maps.Map(document.getElementById("map"), {
          center: coord,
          zoom: 20,
          mapTypeId: "satellite"
        });
      } else {
        overlays.forEach(o => o.setMap(null));
        overlays = [];
        map.setCenter(coord);
      }

      // Vẽ hướng Bắc đỏ
      const R = 6378137;
      const northSize = 15;
      const dLat = northSize / R * 180 / Math.PI;
      const northEnd = { lat: coord.lat + dLat, lng: coord.lng };

      const northLineRed = new google.maps.Polyline({
        path: [coord, northEnd],
        map: map,
        strokeColor: '#FF0000',
        strokeOpacity: 1,
        strokeWeight: 5,
        zIndex: 999
      });
      overlays.push(northLineRed);

      const northLineWhite = new google.maps.Polyline({
        path: [coord, northEnd],
        map: map,
        strokeColor: '#FFFFFF',
        strokeOpacity: 1,
        strokeWeight: 3,
        zIndex: 999
      });
      overlays.push(northLineWhite);

      new google.maps.Marker({
        position: northEnd,
        map: map,
        icon: {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
          scale: 3,
          strokeColor: "#FF0000",
          fillColor: "#FF0000",
          fillOpacity: 1,
        },
        zIndex: 999
      });

      // Vẽ hàng rào
      let basePoints;
      const offset = 3;

      if (foundationType === "self35" || foundationType === "self30") {
        basePoints = [
          { x: -offset, y: -offset },
          { x: -offset, y: height - offset },
          { x: width - offset, y: height - offset },
          { x: width - offset, y: -offset }
        ];
      } else {
        basePoints = [
          { x: 0, y: 0 },
          { x: -width, y: 0 },
          { x: -width, y: height },
          { x: 0, y: height }
        ];
      }

      const rotatedFence = basePoints.map(p => rotateXY(p.x, p.y, -azimuth)).map(p => moveLatLng(coord, p.x, p.y));
      const fence = new google.maps.Polygon({
        paths: rotatedFence,
        map: map,
        strokeColor: '#0000FF',
        fillColor: '#0000FF',
        strokeOpacity: 0.8,
        fillOpacity: 0.3,
        strokeWeight: 2
      });
      overlays.push(fence);

      // Vẽ tam giác đều màu cam nếu móng tự đứng
      if (foundationType === "self35" || foundationType === "self30") {
        const trianglePoints = drawEquilateralTriangle(coord, 4, azimuth);
        const triangle = new google.maps.Polygon({
          paths: trianglePoints,
          map: map,
          strokeColor: '#FFA500',
          fillColor: '#FFA500',
          strokeWeight: 2,
          fillOpacity: 0.5
        });
        overlays.push(triangle);
      }

      // Vẽ cổng ở góc trên cùng bên trái hàng rào
      let topLeft;
      if (foundationType === "self35" || foundationType === "self30") {
        topLeft = { x: -offset, y: height - offset };
      } else {
        topLeft = { x: -width, y: height };
      }

      const topLeftPos = moveLatLng(coord, ...Object.values(rotateXY(topLeft.x, topLeft.y, -azimuth)));
      const doorSize = { w: 1, h: 2 };
      const doorHalfW = doorSize.w / 2;
      const doorHalfH = doorSize.h / 2;
      const doorCorners = [
        { x: -doorHalfW, y: -doorHalfH },
        { x: doorHalfW, y: -doorHalfH },
        { x: doorHalfW, y: doorHalfH },
        { x: -doorHalfW, y: doorHalfH }
      ].map(p => rotateXY(p.x, p.y, -azimuth)).map(p => moveLatLng(topLeftPos, p.x, p.y));
      const doorRect = new google.maps.Polygon({
        paths: doorCorners,
        map: map,
        fillColor: '#FFA500',
        fillOpacity: 1,
        strokeColor: '#FFA500',
        strokeWeight: 1
      });
      overlays.push(doorRect);

      // Vẽ dây co + móng bê tông khi foundation là dây co
      if (foundationType === "guyed") {
        const baseAngles = guyCount === 3 ? [60, 180, 300] : [45, 135, 225, 315];
        baseAngles.forEach(angleOffset => {
          const angle = azimuth + angleOffset;
          const dx = radius * Math.sin(angle * Math.PI / 180);
          const dy = radius * Math.cos(angle * Math.PI / 180);
          const target = moveLatLng(coord, dx, dy);

          const line = new google.maps.Polyline({
            path: [coord, target],
            map: map,
            strokeColor: '#FF0000',
            strokeOpacity: 0.9,
            strokeWeight: 2
          });
          overlays.push(line);

          drawConcreteFootingFromTarget(target, angle);
        });
      }

      // Vẽ vòng cung chỉ góc azimuth
      drawArc(coord, 8, 0, azimuth, '#00FF00');

      // Cập nhật dòng thông tin
      const siteCode = document.getElementById("siteCode").value.trim();
      let foundationName = "";
      switch (foundationType) {
        case "guyed": foundationName = "Dây co"; break;
        case "self35": foundationName = "Tự đứng 35m"; break;
        case "self30": foundationName = "Tự đứng 30m"; break;
      }

      document.getElementById("infoUpdate").textContent = 
        `Trạm: ${siteCode} | Tọa độ MO: ${coord.lat.toFixed(6)}, ${coord.lng.toFixed(6)} | Azimuth: ${azimuth}° | Hàng rào: ${width}x${height} m | Móng cột: ${foundationName} | Số móng co: ${guyCount} | Cao cột: ${towerHeight} m`;
    }

    document.getElementById("drawBtn").addEventListener("click", drawLayout);

    // Khóa/mở số móng co và độ cao cột theo loại móng
    document.getElementById("foundationType").addEventListener("change", () => {
      const type = document.getElementById("foundationType").value;
      const guyCountSelect = document.getElementById("guyCount");
      const towerHeightSelect = document.getElementById("towerHeight");

      if (type === "guyed") {
        guyCountSelect.disabled = false;
        towerHeightSelect.disabled = false;
      } else if (type === "self35" || type === "self30") {
        guyCountSelect.disabled = true;
        towerHeightSelect.disabled = true;
      }
    });

    // Khởi tạo trạng thái ban đầu theo giá trị mặc định
    window.addEventListener("load", () => {
      const event = new Event("change");
      document.getElementById("foundationType").dispatchEvent(event);
    });

    function initMap() {
      try {
        const coord = parseCoord(document.getElementById("moCoord").value);
        map = new google.maps.Map(document.getElementById("map"), {
          center: coord,
          zoom: 20,
          mapTypeId: "satellite"
        });
      } catch {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -25.9493454, lng: 32.5620781 },
          zoom: 20,
          mapTypeId: "satellite"
        });
      }
    }

    // Hàm xóa nội dung input khi focus
    function clearInput(element) {
      if (!element.dataset.cleared) {
        element.value = "";
        element.dataset.cleared = "true";
      }
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxOrCC56tuPjujnYB53luYRqe2aN-fvik&callback=initMap" async defer></script>
</body>
</html>
